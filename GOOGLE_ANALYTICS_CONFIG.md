# Google Analytics 4 (GA4) 配置指南

## 📊 当前配置状态

### ✅ 已实现功能
- **基础页面浏览追踪**：自动追踪页面浏览事件
- **环境区分**：仅在 `NEXT_PUBLIC_ENV=pro` 时启用GA
- **表单事件追踪**：表单提交、验证失败、项目类型选择等事件
- **转化追踪**：潜在客户生成事件追踪
- **自定义维度**：项目类型、表单提交状态、用户类型等

### 🔧 技术实现
- **GA4库版本**：`@next/third-parties@latest`
- **追踪方式**：增强型测量 + 自定义事件
- **数据层**：使用 `gtag` 全局函数

## 🎯 Google Analytics 控制台配置

### 1. 转化目标配置

#### ⚠️ 重要说明：如何标记事件为转化

在GA4控制台中，**"标记为转化"实际上就是"标记为关键事件"**<mcreference link="https://loudseas.com/5698.html" index="1">1</mcreference>。配置位置是：

1. **进入GA4控制台** → **管理** → **数据流**（选择对应的网站数据流）→ **事件**
2. 在**事件列表**中找到相应事件（如`form_submit`）
3. 在该事件所对应的**标记为关键事件列**中，点击打开相应开关

**需要标记为转化的事件**：
- ✅ `form_submit`（表单提交成功）
- ✅ `form_start`（表单开始填写）  
- ✅ `click`（项目类型选择）
- ❌ `form_error`（表单验证失败，仅用于监控）

> **配置优先级建议**: 按以下顺序配置转化目标，确保最重要的转化优先追踪

#### 🎯 主要转化目标（高价值）

**GA控制台路径**：  
**左侧导航栏** → **管理** → **数据流**（选择对应的网站数据流）→ **事件** → 点击要修改的事件 → 启用"标记为关键事件"开关

##### 1. lead_generated（潜在客户生成）
- **事件名称**: `lead_generated`
- **描述**: 用户成功提交联系表单，生成潜在客户
- **标记为转化**: ✅ 勾选
- **价值**: 1
- **代码对应**: `GAEvents.LEAD_GENERATED`
- **GA控制台配置步骤**:
  1. 在"修改事件"页面，点击"创建"
  2. **基本配置**:
     - 事件名称: `lead_generated`
     - 描述: 潜在客户生成
     - 标记为转化: 勾选
     - 价值: 1
  3. **匹配条件**:
     - 参数: `event_name`
     - 运算符: **等于**（选择此项）
     - 值: `lead_generated`
  4. **修改参数**（重要）:
     - 参数: `event_category` → 新值: "conversion"
     - 参数: `event_label` → 新值: "lead_generated"
     - 参数: `value` → 新值: 1

##### 2. form_submit（表单提交成功）
- **事件名称**: `form_submit`
- **描述**: 用户成功提交联系表单
- **标记为转化**: ✅ 勾选
- **价值**: 0.5
- **代码对应**: `GAEvents.FORM_SUBMIT`
- **GA控制台配置步骤**:
  1. **基本配置**:
     - 事件名称: `form_submit`
     - 描述: 表单提交成功
     - 价值: 0.5
  2. **匹配条件**:
     - 参数: `event_name`
     - 运算符: **等于**（选择此项）
     - 值: `form_submit`
  3. **修改参数**（重要）:
     - 参数: `event_category` → 新值: "form_submission"
     - 参数: `event_label` → 新值: "contact_form_success"
     - 参数: `project_type` → 新值: `{{project_type}}`
     - 参数: `lead_value` → 新值: 1

#### 📊 次要转化目标（监控指标）

##### 3. form_start（表单开始填写）
- **事件名称**: `form_start`
- **描述**: 用户开始填写联系表单
- **标记为转化**: ✅ 勾选
- **价值**: 0.1
- **代码对应**: `GAEvents.FORM_START`
- **GA控制台配置步骤**:
  1. **基本配置**:
     - 事件名称: `form_start`
     - 描述: 表单开始填写
     - 价值: 0.1
  2. **匹配条件**:
     - 参数: `event_name`
     - 运算符: **等于**（选择此项）
     - 值: `form_start`
  3. **修改参数**:
     - 参数: `event_category` → 新值: "form_submission"
     - 参数: `event_label` → 新值: "contact_form_start"
     - 参数: `project_type` → 新值: "{{project_type}}" 

##### 4. click（项目类型选择）
- **事件名称**: `click`
- **描述**: 用户在表单中选择项目类型
- **标记为转化**: ✅ 勾选
- **价值**: 0.05
- **代码对应**: `GAEvents.CLICK` + 特定标签筛选
- **重要说明**: `click`是GA4自动收集事件，在"管理-事件"页面中不会直接显示，需要通过"修改事件"功能创建自定义转化
- **GA控制台配置步骤**:
  1. **基本配置**:
     - 事件名称: `click`
     - 描述: 项目类型选择
     - 价值: 0.05
  2. **匹配条件**（关键步骤）:
     - 参数: `event_name`
     - 运算符: **等于**（选择此项）
     - 值: `click`
     - 添加参数条件: 
       - 参数: `event_label`
       - 运算符: **等于**（选择此项）
       - 值: "project_type_selected"
  3. **修改参数**:
     - 参数: `event_category` → 新值: "form_interaction"
     - 参数: `project_type` → 新值: "{{project_type}}" 

##### 5. form_error（表单验证失败）
- **事件名称**: `form_error`
- **描述**: 表单验证失败，用于识别表单优化机会
- **标记为转化**: ❌ 不勾选（仅用于监控）
- **价值**: 0
- **代码对应**: `GAEvents.FORM_ERROR`
- **GA控制台配置步骤**:
  1. **基本配置**:
     - 事件名称: `form_error`
     - 描述: 表单验证失败
  2. **匹配条件**:
     - 参数: `event_name`
     - 运算符: **等于**（选择此项）
     - 值: `form_error`
  3. **修改参数**:
     - 参数: `event_category` → 新值: "form_validation"
     - 参数: `event_label` → 新值: "validation_failed"
     - 参数: `error_fields` → 新值: "{{error_fields}}"

### 2. 自定义维度配置

在GA4控制台中配置以下自定义维度：

**GA控制台操作路径**：  
**左侧导航栏** → **管理** →**数据显示** → **自定义设置** → **自定义维度** → **创建自定义维度**

#### 自定义维度配置

**重要提示**：在配置自定义维度之前，必须先确保相应的事件参数已经被GA4收集到。如果输入参数后报错，请先触发相应的事件，等待24-48小时后GA4收集到数据再配置。

1. **项目类型** (`project_type`)
   - **范围**: 事件
   - **描述**: 用户选择的项目类型
   - **可能值**: 数字展馆/展厅、企业展厅、博物馆/美术馆等
   - **配置步骤**:
     - **维度名称**: `project_type`
     - **范围**: 选择"事件"
     - **描述**: "用户选择的项目类型"
     - **事件参数**: 输入`project_type`（如果报错，请先触发项目选择事件）

2. **表单提交状态** (`form_submitted`)
   - **范围**: 用户
   - **描述**: 用户是否已提交过表单
   - **可能值**: true/false
   - **配置步骤**:
     - **维度名称**: `form_submitted`
     - **范围**: 选择"用户"
     - **描述**: "用户是否已提交过表单"
     - **用户属性**: `form_submitted`

3. **用户类型** (`user_type`)
   - **范围**: 用户
   - **描述**: 用户类型分类
   - **可能值**: new_visitor, lead, customer
   - **配置步骤**:
     - **维度名称**: `user_type`
     - **范围**: 选择"用户"
     - **描述**: "用户类型分类"
     - **用户属性**: `user_type`

### 3. 自定义指标配置

**重要提示**：在配置自定义指标之前，必须先确保相应的事件参数已经被GA4收集到。如果输入参数后报错，请先触发相应的事件，等待24-48小时后GA4收集到数据再配置。

1. **潜在客户价值** (`lead_value`)
   - **范围**: 事件
   - **描述**: 潜在客户的价值
   - **格式**: 整数
   - **配置步骤**:
     - **指标名称**: `lead_value`
     - **范围**: 选择"事件"
     - **描述**: "潜在客户的价值"
     - **事件参数**: 输入`lead_value`（如果报错，请先触发表单提交事件）
     - **衡量单位**: 选择"标准"（或根据实际需求选择）

### 4. 漏斗分析配置

#### 联系表单转化漏斗
**漏斗步骤**: 1. **页面浏览** → 2. **表单开始填写** → 3. **项目类型选择** → 4. **表单提交成功**

**GA4控制台配置步骤**:
1. **访问漏斗配置页面**:
   - 登录GA4控制台 → 左侧导航栏 → **探索** → **漏斗分析**
   - 点击 **+ 新建** 创建新的漏斗

2. **配置漏斗步骤**:
   - **步骤1 - 页面浏览**:
     - **步骤名称**: "页面浏览"
     - **配置方法**: 点击"添加步骤" → 在维度选择框中选择"页面/屏幕" → "页面标题" → 在条件设置中选择"完全匹配"或"包含" → 输入您的网站页面标题（如"多媒体播控系统"）

   - **步骤2 - 表单开始填写**:
     - **步骤名称**: "表单开始填写"
     - **配置方法**: 点击"添加步骤" → 在维度选择框中选择"事件" → "事件名称" → 在条件设置中选择"完全匹配" → 输入`form_start` → 点击"添加条件" → 选择参数`event_label`等于"contact_form_start"

   - **步骤3 - 项目类型选择**:
     - **步骤名称": "项目类型选择"
     - **配置方法**: 点击"添加步骤" → 在维度选择框中选择"事件" → "事件名称" → 在条件设置中选择"完全匹配" → 输入`click` → 点击"添加条件" → 选择参数`event_label`等于"project_type_selected"

   - **步骤4 - 表单提交成功**:
     - **步骤名称": "表单提交成功"
     - **配置方法**: 点击"添加步骤" → 在维度选择框中选择"事件" → "事件名称" → 在条件设置中选择"完全匹配" → 输入`form_submit` → 点击"添加条件" → 选择参数`event_label`等于"contact_form_success"

3. **设置漏斗参数**:
   - **转化窗口**: 设置30天（默认）
   - **回溯窗口**: 设置5分钟（默认）
   - **漏斗可视化**: 选择"标准漏斗"

4. **保存漏斗**:
   - 点击 **保存** 按钮
   - 输入漏斗名称："联系表单转化漏斗"
   - 选择保存位置："我的报告"或"共享报告"

**重要提示**:
- 确保所有事件都已在GA4中正确配置并收集到数据
- 漏斗分析需要至少24小时的数据才能显示完整结果
- 如果某个步骤没有数据，请检查对应的事件是否已触发

### 5. 受众群体配置

#### 高价值受众
1. **表单提交者**
   - **条件**: `form_submitted = true`
   - **描述**: 已提交联系表单的用户

2. **特定项目类型兴趣者**
   - **条件**: `project_type = [具体类型]`
   - **描述**: 对特定项目类型感兴趣的用户

3. **高参与度用户**
   - **条件**: 页面停留时间 > 3分钟 且 浏览页面 > 5
   - **描述**: 对内容高度感兴趣的用户

## 🔍 事件追踪详情

### 自动追踪事件
- **page_view**: 页面浏览（自动）
- **scroll**: 页面滚动（自动）
- **click**: 链接点击（自动）

### 自定义事件（与代码完全匹配）

#### 📝 表单相关事件（Contact.tsx中实现）
```javascript
// 表单开始填写（用户点击提交按钮时触发）
gtag('event', 'form_start', {
  event_category: 'form_submission',
  event_label: 'contact_form_start',
  project_type: '数字展馆/展厅' // 动态获取当前选择的项目类型
})

// 表单提交成功（生产环境实际提交后触发）
gtag('event', 'form_submit', {
  event_category: 'form_submission',
  event_label: 'contact_form_success',
  project_type: '数字展馆/展厅', // 动态获取提交时的项目类型
  lead_value: 1
})

// 表单验证失败（表单验证不通过时触发）
gtag('event', 'form_error', {
  event_category: 'form_validation',
  event_label: 'validation_failed',
  error_fields: 'contactName,contactPhone' // 动态获取验证失败的字段
})

// 表单提交失败（网络错误等异常情况）
gtag('event', 'form_error', {
  event_category: 'form_submission',
  event_label: 'contact_form_error',
  error_message: '网络连接失败' // 动态获取错误信息
})
```

#### 👆 用户交互事件
```javascript
// 项目类型选择（用户选择项目类型时触发）
gtag('event', 'click', {
  event_category: 'form_interaction',
  event_label: 'project_type_selected',
  project_type: '数字展馆/展厅' // 动态获取选择的项目类型
})
```

#### 🎯 转化事件
```javascript
// 潜在客户生成（表单成功提交后触发）
gtag('event', 'lead_generated', {
  event_category: 'conversion',
  event_label: 'lead_generated',
  value: 1
})
```

### 🔧 开发环境事件追踪
```javascript
// 开发环境表单提交成功（仅打印日志，不实际发送）
gtag('event', 'form_submit', {
  event_category: 'form_submission',
  event_label: 'contact_form_success_dev',
  project_type: '数字展馆/展厅',
  lead_value: 1
})
```

## 🎯 GA控制台配置详细指南

### ⚠️ 重要注意事项
- **参数配置必须与代码完全匹配**，否则转化目标无法正确触发
- **操作类型必须选择"设置"**，而不是"复制"或其他选项
- **字符串值需要用双引号包裹**，如："conversion"
- **动态参数选择"事件参数"**，而不是直接输入值

### 配置转化目标的详细步骤

#### 第一步：访问GA4控制台
1. 访问 [analytics.google.com](https://analytics.google.com)
2. 选择您的GA4媒体资源
3. 点击左侧菜单的 **"管理"**（齿轮图标）

#### 第二步：配置转化目标
1. 在管理页面，点击 **"数据流"** → 选择您的数据流
2. 点击 **"修改事件"** → **"创建"**
3. 按以下顺序配置5个转化目标：

##### 1️⃣ lead_generated（主要转化）
- **事件名称**: `lead_generated`
- **描述**: 潜在客户生成
- **标记为转化**: ✅ 勾选
- **价值**: 1
- **参数配置**（修改参数部分）:
  - **参数1**: `event_category` → **操作类型**: "设置" → **值**: "conversion"
  - **参数2**: `event_label` → **操作类型**: "设置" → **值**: "lead_generated"
  - **参数3**: `value` → **操作类型**: "设置" → **值**: 1

##### 2️⃣ form_submit（主要转化）
- **事件名称**: `form_submit`
- **描述**: 表单提交成功
- **标记为转化**: ✅ 勾选
- **价值**: 0.5
- **参数配置**（修改参数部分）:
  - **参数1**: `event_category` → **操作类型**: "设置" → **值**: "form_submission"
  - **参数2**: `event_label` → **操作类型**: "设置" → **值**: "contact_form_success"
  - **参数3**: `project_type` → **操作类型**: "设置" → **值类型**: "事件参数" → **参数名称**: `project_type`
  - **参数4**: `lead_value` → **操作类型**: "设置" → **值**: 1

##### 3️⃣ form_start（次要转化）
- **事件名称**: `form_start`
- **描述**: 表单开始填写
- **标记为转化**: ✅ 勾选
- **价值**: 0.1
- **参数配置**（修改参数部分）:
  - **参数1**: `event_category` → **操作类型**: "设置" → **值**: "form_submission"
  - **参数2**: `event_label` → **操作类型**: "设置" → **值**: "contact_form_start"
  - **参数3**: `project_type` → **操作类型**: "设置" → **值类型": "事件参数" → **参数名称**: `project_type`

##### 4️⃣ click（项目类型选择）
- **事件名称**: `click`
- **描述**: 项目类型选择
- **标记为转化**: ✅ 勾选
- **价值**: 0.05
- **匹配条件**（关键步骤）: 
  - 条件类型: "自定义事件"
  - 事件名称: `click`
  - 添加参数条件: `event_label` = "project_type_selected"
- **参数配置**（修改参数部分）:
  - **参数1**: `event_category` → **操作类型**: "设置" → **值**: "form_interaction"
  - **参数2**: `project_type` → **操作类型**: "设置" → **值类型**: "事件参数" → **参数名称**: `project_type`

##### 5️⃣ form_error（监控指标）
- **事件名称**: `form_error`
- **描述**: 表单验证失败
- **标记为转化**: ❌ 不勾选（仅用于监控）
- **参数配置**（修改参数部分）:
  - **参数1**: `event_category` → **操作类型**: "设置" → **值**: "form_validation"
  - **参数2**: `event_label` → **操作类型**: "设置" → **值**: "validation_failed"
  - **参数3**: `error_fields` → **操作类型**: "设置" → **值类型**: "事件参数" → **参数名称**: `error_fields`

#### 第三步：配置自定义维度
1. 在管理页面，点击 **"自定义定义"** → **"自定义维度"**
2. 创建以下维度：
   - **project_type**（范围: 事件）
   - **form_submitted**（范围: 用户）
   - **user_type**（范围: 用户）

#### 第四步：验证配置
1. 在 **"报告"** → **"实时"** 中测试表单提交
2. 确认事件在实时报告中显示
3. 等待24-48小时查看转化数据

### 🔧 常见问题解决

#### 问题1："参数不能为空"错误
**解决方案**: 确保所有参数都正确配置：
- 操作类型选择"设置"
- 字符串值用双引号包裹
- 动态参数选择"事件参数"

#### 问题2：转化目标不触发
**解决方案**: 检查以下配置：
- 事件名称与代码完全匹配
- 匹配条件正确设置
- 参数名称拼写正确

#### 问题3：实时报告不显示事件
**解决方案**: 
- 确认网站已正确集成GA4
- 检查浏览器控制台是否有错误
- 等待几分钟数据延迟

## ⚙️ 环境配置

### 开发环境 (`NEXT_PUBLIC_ENV=dev`)
- GA事件仅在控制台打印日志
- 不向Google Analytics发送真实数据
- 便于测试和调试

### 生产环境 (`NEXT_PUBLIC_ENV=pro`)
- 启用完整的GA4追踪
- 发送真实数据到Google Analytics
- 包含所有自定义事件和维度

## 📈 报告和分析

### 关键指标监控
1. **转化率**: 表单提交数 / 页面浏览数
2. **项目类型分布**: 各项目类型的表单提交比例
3. **用户行为路径**: 用户从浏览到提交的完整路径
4. **跳出率**: 仅浏览首页即离开的用户比例

### 自定义报告建议
1. **项目类型转化报告**
   - 维度: 项目类型
   - 指标: 表单提交数、转化率、平均停留时间

2. **用户行为漏斗报告**
   - 步骤: 浏览 → 表单开始 → 项目选择 → 提交成功
   - 分析各步骤的流失率

3. **设备和技术报告**
   - 维度: 设备类型、浏览器、操作系统
   - 指标: 转化率、页面停留时间

## 🔧 故障排除

### 常见问题
1. **事件未显示在GA控制台**
   - 检查环境变量 `NEXT_PUBLIC_ENV` 是否为 `pro`
   - 确认GA测量ID配置正确
   - 等待24-48小时数据延迟

2. **自定义维度未生效**
   - 确认在GA控制台已正确配置自定义维度
   - 检查维度名称拼写是否一致
   - 验证维度范围设置正确

3. **转化目标未触发**
   - 确认事件名称和参数匹配
   - 检查转化目标的配置条件
   - 验证事件是否在实时报告中显示

### 调试方法
1. **开发环境日志**
   - 在浏览器控制台查看GA事件日志
   - 确认事件参数正确传递

2. **GA调试模式**
   - 安装Google Analytics调试器扩展
   - 查看详细的事件发送信息

3. **实时报告**
   - 在GA控制台查看实时事件报告
   - 确认事件正确发送到GA

## 📚 最佳实践

### 数据隐私
- 启用IP匿名化
- 遵守GDPR和CCPA要求
- 提供用户选择退出机制

### 性能优化
- 使用异步加载GA脚本
- 避免过度追踪影响页面性能
- 合理设置数据采样率

### 数据质量
- 定期审核事件配置
- 监控数据异常
- 保持事件命名一致性

---








## 🚀 下一步操作建议
### 1. GA控制台配置
按照 GOOGLE_ANALYTICS_CONFIG.md 文档，在Google Analytics控制台中配置：

- 转化目标
    左侧菜单 → 管理（齿轮图标） → 数据流 → 选择您的数据流 → 修改事件（配置事件和转化目标）
- 自定义维度
- 受众群体
- 漏斗分析
### 2. 测试验证
- 访问 http://localhost:3000 测试表单提交
- 在浏览器控制台查看GA事件日志
- 确认开发环境只打印日志，不发送真实数据
### 3. 生产环境部署
- 设置 NEXT_PUBLIC_ENV=pro 启用真实GA追踪
- 监控GA实时报告确认数据正确接收
- 定期分析转化报告优化营销策略